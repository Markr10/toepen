using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Data;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;
using toepenTest.Connection;
using toepenTest.Json;


namespace toepenTest
{
    /// <summary>
    /// Interaction logic for MainWindow.xaml
    /// </summary>
    public partial class MainWindow : Window
    {
        // Also in MainWindow.xaml
        private static readonly Uri NO_CARD_URI = new Uri("pack://application:,,,/resources/images/legekaart.png", UriKind.Absolute);

        private bool continueApp;
        private string cardsToShow;

        public MainWindow(string playerName)
        {
            //WindowStartupLocation = System.Windows.WindowStartupLocation.CenterScreen;
            InitializeComponent();

            continueApp = false;

            Conn.GetClient().MessageListEvent += new MessageListEventHandler(AddMessageToListBox);

            CheckAndPrepareNewTrickOrRound(false);

            messageList.Items.Add("Welkom " + playerName + "!");
        }

        /// <summary>
        /// Setting the images based on the sorted cards
        /// </summary>
        /// <param name="playerCardsObj">The cardobject used </param>
        /// <param name="sender"></param>
        public void SetCardImages(PlayerCards playerCardsObj, object sender)
        {
            if (!Dispatcher.CheckAccess()) // CheckAccess returns true if you're on the dispatcher thread
            {
                Dispatcher.Invoke(new PlayerCardsEventHandler(SetCardImages), playerCardsObj, sender);
                return;
            }
            else
            {
                if (sender == null)
                {
                    Conn.GetClient().PlayerCardsEvent -= new PlayerCardsEventHandler(SetCardImages);
                }

                ChangeCardImage(1, playerCardsObj.Card1);
                ChangeCardImage(2, playerCardsObj.Card2);
                ChangeCardImage(3, playerCardsObj.Card3);
                ChangeCardImage(4, playerCardsObj.Card4);

                CheckDirtyLaundry();
            }
        }

        /// <summary>
        /// Is there dirty laundry?
        /// </summary>
        public void CheckDirtyLaundry()
        {
            //if (!Dispatcher.CheckAccess()) // CheckAccess returns true if you're on the dispatcher thread
            //{
            //    Dispatcher.Invoke(new DirtyLaundryEventHandler(CheckDirtyLaundry));
            //    return;
            //}
            //else
            //{
            // REMARK Mogelijk geen event aangekoppelt
            //    Conn.GetClient().DirtyLaundryEvent -= new DirtyLaundryEventHandler(CheckDirtyLaundry);

                if (MessageBox.Show("Wilt u vuile was melden?", "Vuile was", MessageBoxButton.YesNo, MessageBoxImage.None, MessageBoxResult.No) == MessageBoxResult.No)
                {
                    // No dirty laundry
                    Conn.GetClient().SendDirtyLaundry(false);
                }
                else
                {
                    // REMARK Mogelijk geen event aangekoppelt
                    //Conn.GetClient().DirtyLaundryEvent += new DirtyLaundryEventHandler(CheckDirtyLaundry);
                    // Dirty laundry
                    Conn.GetClient().PlayerExtraCardsEvent += new PlayerExtraCardsEventHandler(SetExtraCards);
                    Conn.GetClient().SendDirtyLaundry(true);
                }
            //}
        }

        /// <summary>
        /// Dirty Laundry! Set extra cards
        /// </summary>
        /// <param name="playerExtraCardsObj"></param>
        public void SetExtraCards(PlayerExtraCards playerExtraCardsObj)
        {
            if (!Dispatcher.CheckAccess()) // CheckAccess returns true if you're on the dispatcher thread
            {
                Dispatcher.Invoke(new PlayerExtraCardsEventHandler(SetExtraCards), playerExtraCardsObj);
                return;
            }
            else
            {
                // REMARK Mogelijk geen event aangekoppelt
                Conn.GetClient().PlayerExtraCardsEvent -= new PlayerExtraCardsEventHandler(SetExtraCards);
                                
                if (playerExtraCardsObj.PlayerGetExtraCards)
                {
                    SetCardImages(playerExtraCardsObj, null);
                    AddMessageToListBox("Je hebt nieuwe kaarten gekregen.");
                }
            }
        }

        /// <summary>
        /// Player has played a card
        /// </summary>
        /// <param name="cardField">Lege kaart wordt vervangen door de gespeelde kaart</param>
        /// <param name="card">De kaart die gespeeld is</param>
        public void SetCardField(int cardField, String card)
        {
            if (!Dispatcher.CheckAccess()) // CheckAccess returns true if you're on the dispatcher thread
            {
                Dispatcher.Invoke(new ReceivePlayedCardEventHandler(SetCardField), cardField, card);
                return;
            }
            else
            {
                AddMessageToListBox("Speler speelt kaart");
                SetLegeKaart(cardField, card);
                CheckAndPrepareNewTrickOrRound(true);
            }
        }
        
        /// <summary>
        /// After each turn add text to the listbox
        /// </summary>
        /// <param name="text">The text to add to the listbox</param>
        public void AddMessageToListBox(String text)
        {
            if (!Dispatcher.CheckAccess()) // CheckAccess returns true if you're on the dispatcher thread
            {
                Dispatcher.Invoke(new MessageListEventHandler(AddMessageToListBox), text);
                return;
            }
            else
            {
                messageList.Items.Add(text);
            }
        }

        /// <summary>
        /// Reset the score of a round, and add the penaltys to the listbox
        /// </summary>
        /// <param name="text">The penaltys the player has earned</param>
        public void ResetAndAddScoreToListBox(String text)
        {
            if (!Dispatcher.CheckAccess()) // CheckAccess returns true if you're on the dispatcher thread
            {
                Dispatcher.Invoke(new ResetScoreListEventHandler(ResetAndAddScoreToListBox), text);
                return;
            }
            else
            {
                Conn.GetClient().ResetScoreListEvent -= new ResetScoreListEventHandler(ResetAndAddScoreToListBox);
                scoreList.Items.Clear();
                AddScoreToListBox(text);
            }
        }

        /// <summary>
        /// Add penaltys to listbox of the player
        /// </summary>
        /// <param name="text">The penaltys</param>
        public void AddScoreToListBox(String text)
        {
            if (!Dispatcher.CheckAccess()) // CheckAccess returns true if you're on the dispatcher thread
            {
                Dispatcher.Invoke(new ScoreListEventHandler(AddScoreToListBox), text);
                return;
            }
            else
            {
                scoreList.Items.Add(text);
            }
        }

        /// <summary>
        /// Activate cards when player has to play a card
        /// </summary>
        /// <param name="sender">The current player</param>
        public void ActivateCards(object sender)
        {
            if (!Dispatcher.CheckAccess()) // CheckAccess returns true if you're on the dispatcher thread
            {
                Dispatcher.Invoke(new ActivateCardsEventHandler(ActivateCards), sender);
                return;
            }
            else
            {
                // TODO Check if no eventhandler is active in case of null value of sender
                if (sender != null)
                {
                    Conn.GetClient().ActivateCardsEvent -= new ActivateCardsEventHandler(ActivateCards);
                    messageList.Items.Add("Jij bent aan de beurt.");
                }
                ChangeActiveStatusCards();
            }
        }

        /// <summary>
        /// Check if the card that the player wants to play is allowed to play
        /// If the player has a card that matches the first card color, that color has to be played
        /// </summary>
        /// <param name="cardValid">Is true or false</param>
        /// <param name="indexOfCardField">The index of the card (0, 1, 2, 3)</param>
        private void HandleValidCard(bool cardValid, int indexOfCardField)
        {
            if (!Dispatcher.CheckAccess()) // CheckAccess returns true if you're on the dispatcher thread
            {
                Dispatcher.Invoke(new PlayedCardValidEventHandler(HandleValidCard), cardValid, indexOfCardField);
                return;
            }
            else
            {
                Conn.GetClient().PlayedCardValidEvent -= new PlayedCardValidEventHandler(HandleValidCard);

                if (cardValid)
                {
                    MoveCard(indexOfCardField);
                    Conn.GetClient().ActivateCardsEvent += new ActivateCardsEventHandler(ActivateCards);
                    CheckAndPrepareNewTrickOrRound(true);
                }
                else
                {
                    messageList.Items.Add("Je moet een andere kaart opgooien.");
                    ActivateCards(null);
                }
            }
        }

        //public void SetNewRound()
        //{
        //    if (!Dispatcher.CheckAccess()) // CheckAccess returns true if you're on the dispatcher thread
        //    {
        //        Dispatcher.Invoke(new SetNewRoundEventHandler(SetNewRound));
        //        return;
        //    }
        //    else
        //    {
        //        Conn.GetClient().SetNewRoundEvent -= new SetNewRoundEventHandler(SetNewRound);

        //        Conn.GetClient().StartNewRoundEvent += new StartNewRoundEventHandler(StartNewRound);

        //    }
        //}

        /// <summary>
        /// To start a new round
        /// </summary>
        public void StartNewRound()
        {
            if (!Dispatcher.CheckAccess()) // CheckAccess returns true if you're on the dispatcher thread
            {
                Dispatcher.Invoke(new StartNewRoundEventHandler(StartNewRound));
                return;
            }
            else
            {
                Conn.GetClient().StartNewRoundEvent -= new StartNewRoundEventHandler(StartNewRound);
                Conn.GetClient().ScoreListEvent -= new ScoreListEventHandler(AddScoreToListBox);

                Conn.GetClient().ActivateCardsEvent += new ActivateCardsEventHandler(ActivateCards);
                Conn.GetClient().ReceivePlayedCardEvent += new ReceivePlayedCardEventHandler(SetCardField);
            }
        }

        /// <summary>
        /// Reset all cards on the table of other players
        /// </summary>
        public void ResetOtherPlayerCards()
        {
            if (!Dispatcher.CheckAccess()) // CheckAccess returns true if you're on the dispatcher thread
            {
                Dispatcher.Invoke(new StartNewTrickEventHandler(ResetOtherPlayerCards));
                return;
            }
            else
            {
                Conn.GetClient().StartNewTrickEvent -= new StartNewTrickEventHandler(ResetOtherPlayerCards);

                BitmapImage bmpLeeg = new BitmapImage(NO_CARD_URI);
                legeKaart1.Source = bmpLeeg;
                legeKaart2.Source = bmpLeeg;
                legeKaart3.Source = bmpLeeg;
                legeKaart4.Source = bmpLeeg;
            }
        }

        /// <summary>
        /// ???
        /// </summary>
        /// <param name="card"></param>
        public void AllCards(string card)
        {
            cardsToShow += card + "\r\n";
        }

        /// <summary>
        /// ???
        /// </summary>
        /// <param name="imageSourcePath"></param>
        private void HandleClickOnKaart(string imageSourcePath)
        {
            ChangeActiveStatusCards();

            Conn.GetClient().PlayedCardValidEvent += new PlayedCardValidEventHandler(HandleValidCard);
            Conn.GetClient().SendCard(GetCardFromImageSourcePath(imageSourcePath));
        }

        /// <summary>
        /// Enables or disable not played cards
        /// </summary>
        /// <returns>How much card are enabled or disabled</returns>
        private void ChangeActiveStatusCards()
        {
            if (!kaart1Image.Source.ToString().Equals(NO_CARD_URI.ToString()))
            {
                kaart1.IsEnabled = !kaart1.IsEnabled;
            }
            if (!kaart2Image.Source.ToString().Equals(NO_CARD_URI.ToString()))
            {
                kaart2.IsEnabled = !kaart2.IsEnabled;
            }
            if (!kaart3Image.Source.ToString().Equals(NO_CARD_URI.ToString()))
            {
                kaart3.IsEnabled = !kaart3.IsEnabled;
            }
            if (!kaart4Image.Source.ToString().Equals(NO_CARD_URI.ToString()))
            {
                kaart4.IsEnabled = !kaart4.IsEnabled;
            }
        }

        /// <summary>
        /// Het voorbereiden van een nieuwe slag of ronde
        /// </summary>
        /// <param name="notFirstRun">Is er al een slag gespeeld?</param>
        private void CheckAndPrepareNewTrickOrRound(bool notFirstRun)
        {
            // Return if current trick is not completed
            if (legeKaart1.Source.ToString().Equals(NO_CARD_URI.ToString()) || legeKaart2.Source.ToString().Equals(NO_CARD_URI.ToString()) ||
                    legeKaart3.Source.ToString().Equals(NO_CARD_URI.ToString()) || legeKaart4.Source.ToString().Equals(NO_CARD_URI.ToString()))
            {
                return;
            }
            else
            {
                Conn.GetClient().StartNewTrickEvent += new StartNewTrickEventHandler(ResetOtherPlayerCards);
                
                // If it is a new trick then check if it is also a new round
                if (kaart1Image.Source.ToString().Equals(NO_CARD_URI.ToString()) && kaart2Image.Source.ToString().Equals(NO_CARD_URI.ToString()) &&
                        kaart3Image.Source.ToString().Equals(NO_CARD_URI.ToString()) && kaart4Image.Source.ToString().Equals(NO_CARD_URI.ToString()))
                {
                    PrepareNewRound(notFirstRun);
                }
            }
        }

        /// <summary>
        /// Wordt aangeroepen door CheckAndPrepareNewTrickOrRound na de check -> starten van een nieuwe ronde
        /// </summary>
        /// <param name="notFirstRun">Niet de eerste slag</param>
        private void PrepareNewRound(bool notFirstRun)
        {
            // Unload events that are not possible at this moment
            if (notFirstRun)
            {
                Conn.GetClient().ActivateCardsEvent -= new ActivateCardsEventHandler(ActivateCards);
                Conn.GetClient().ReceivePlayedCardEvent -= new ReceivePlayedCardEventHandler(SetCardField);
            }

            Conn.GetClient().ResetScoreListEvent += new ResetScoreListEventHandler(ResetAndAddScoreToListBox);
            Conn.GetClient().ScoreListEvent += new ScoreListEventHandler(AddScoreToListBox);
            Conn.GetClient().PlayerCardsEvent += new PlayerCardsEventHandler(SetCardImages);
            //Conn.GetClient().SetNewRoundEvent += new SetNewRoundEventHandler(SetNewRound);
            Conn.GetClient().StartNewRoundEvent += new StartNewRoundEventHandler(StartNewRound);
        }

        /// <summary>
        /// De afbeeldingen laden uit de resource folder
        /// </summary>
        /// <param name="imageSourcePath">Het pad naar de afbeelding</param>
        /// <returns>De afbeelding</returns>
        private string GetCardFromImageSourcePath(string imageSourcePath)
        {
            if (!String.IsNullOrEmpty(imageSourcePath))
            {
                string[] card = Regex.Split(imageSourcePath, "/");
                Console.WriteLine(card[card.GetUpperBound(0)]);
                return card[card.GetUpperBound(0)];
            }
            else
            {
                return null;
            }
        }

        /// <summary>
        /// Verplaats de kaart van de stash naar de tafel
        /// </summary>
        /// <param name="indexOfCardField">De index van de beschikbare kaarten (0, 1, 2, 3)</param>
        private void MoveCard(int indexOfCardField)
        {
            string imageSourcePath = String.Empty;
            switch (indexOfCardField)
            {
                case 0: imageSourcePath = kaart1Image.Source.ToString();
                    break;
                case 1: imageSourcePath = kaart2Image.Source.ToString();
                    break;
                case 2: imageSourcePath = kaart3Image.Source.ToString();
                    break;
                case 3: imageSourcePath = kaart4Image.Source.ToString();
                    break;
            }

            string card = GetCardFromImageSourcePath(imageSourcePath);
            if(!String.IsNullOrEmpty(card))
            {
                BitmapImage bmpLeeg = new BitmapImage(NO_CARD_URI);
                switch (indexOfCardField)
                {
                    case 0: kaart1Image.Source = bmpLeeg;
                        break;
                    case 1: kaart2Image.Source = bmpLeeg;
                        break;
                    case 2: kaart3Image.Source = bmpLeeg;
                        break;
                    case 3: kaart4Image.Source = bmpLeeg;
                        break;
                }

                SetLegeKaart(0, card);
            }
        }

        /// <summary>
        /// Na het spelen van een kaart, de tafel positie vullen met de gespeelde kaart
        /// </summary>
        /// <param name="card"></param>
        /// <param name="cardType">The card Type</param>
        private void ChangeCardImage(int card, String cardType)
        {
            //Load the image from local resource
            BitmapImage bmp = new BitmapImage(new Uri("pack://application:,,,/resources/images/" + cardType + ".png", UriKind.Absolute));

            switch (card)
            {
                case 1: kaart1Image.Source = bmp;
                    break;
                case 2: kaart2Image.Source = bmp;
                    break;
                case 3: kaart3Image.Source = bmp;
                    break;
                case 4: kaart4Image.Source = bmp;
                    break;
            }
        }

        /// <summary>
        /// Set an empty card on the played card old place
        /// </summary>
        /// <param name="indexOfCardField">The index of the old card place (0, 1, 2, 3)</param>
        /// <param name="card"></param>
        private void SetLegeKaart(int indexOfCardField, string card)
        {
            BitmapImage bmp = new BitmapImage(new Uri("pack://application:,,,/resources/images/" + card, UriKind.Absolute));

            Console.WriteLine("Bestandspad voor veranderen van lege kaart " + bmp);

            switch (indexOfCardField)
            {
                case 0: legeKaart1.Source = bmp;
                    break;
                case 1: legeKaart2.Source = bmp;
                    break;
                case 2: legeKaart3.Source = bmp;
                    break;
                case 3: legeKaart4.Source = bmp;
                    break;
            }
        }

        /// <summary>
        /// On click first card
        /// </summary>
        private void kaart1_Click(object sender, RoutedEventArgs e)
        {
            HandleClickOnKaart(kaart1Image.Source.ToString());
        }

        /// <summary>
        /// On click second card
        /// </summary>
        /// <param name="sender">The current player</param>
        /// <param name="e"></param>
        private void kaart2_Click(object sender, RoutedEventArgs e)
        {
            HandleClickOnKaart(kaart2Image.Source.ToString());
        }

        /// <summary>
        /// On click third card
        /// </summary>
        private void kaart3_Click(object sender, RoutedEventArgs e)
        {
            HandleClickOnKaart(kaart3Image.Source.ToString());
        }

        /// <summary>
        /// On click fourth card
        /// </summary>
        private void kaart4_Click(object sender, RoutedEventArgs e)
        {
            HandleClickOnKaart(kaart4Image.Source.ToString());
        }

        /// <summary>
        /// The button to start a new came after all players are connected (only the host)
        /// </summary>
        /// <param name="sender">The current player</param>
        /// <param name="e"></param>
        private void buttonStartNewGame_Click(object sender, RoutedEventArgs e)
        {
            ////newGame = new Game();
            //buttonStartNewGame.IsEnabled = false;
        }

        private void buttonDirtyLaundry_Click(object sender, RoutedEventArgs e)
        {
            //char[] delimiters = new char[] { '/', '.' };
            
            //string image1SourcePath = kaart1Image.Source.ToString();
            //string image2SourcePath = kaart2Image.Source.ToString();
            //string image3SourcePath = kaart3Image.Source.ToString();
            //string image4SourcePath = kaart4Image.Source.ToString();

            ////Hierdoor houd je alleen de kaart over, dus zonder .png -> bijvoorbeeld "H9"
            //string[] card1PNG = image1SourcePath.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
            //string[] card2PNG = image2SourcePath.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
            //string[] card3PNG = image3SourcePath.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
            //string[] card4PNG = image4SourcePath.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);

            ////if (newGame.checkVuileWas(card1PNG[4], card2PNG[4], card3PNG[4], card4PNG[4]))
            ////{
            ////    Console.WriteLine(true);
            ////    newGame.dealExtraCards();
            ////}
            ////else
            ////{
            ////    Console.WriteLine(false);
            ////}
        }

        /// <summary>
        /// Function to close the application
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void Window_Closed(object sender, EventArgs e)
        {
            if (!continueApp)
            {
                Environment.Exit(0);
            }
        }
    }
}
